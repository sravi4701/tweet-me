{% extends "base.html" %}

{%block title%}Home {{ block.super }}{% endblock %}
{% block script %}
	<script>
		function getParameterByName(name, url){
			if(!url){
				url = window.location.href;
			}
			name = name.replace(/[\[\]]/g, "\\$&");
			var regex = new RegExp("[?&]" + name + "(=([^$#]*)|&|#|$)"),
				results = regex.exec(url);
				if(!results) return null;
				if(!results[2]) return '';
				return decodeURIComponent(results[2].replace(/\+/g, " "));
		}

		$(document).ready(function(){
			var query = getParameterByName('q')
			console.log(query)
			var tweetList = []
			function parseTweet(){
				if(tweetList == 0){
					$("#tweet-container").append(
							"<h4> No tweets found </h4>"
						)
				}
				else{
					$.each(tweetList, function(key, value){
						var tweetContent = value.content;
						var tweetUser = value.user;
						var dateDisplay = value.date_display
						var tweetKey = key;
						// console.log(key);
						// console.log(value.user.username);
						// console.log(value.content);
						$("#tweet-container").append(
							"<div class=\"media\"><div class=\"media-body\">" + tweetContent + "<br>" + "by " + tweetUser.username + " | " + dateDisplay + " | " + "<a href=\"#\">View</a>" + "</div></div>"
							)
					})
				}
			}

			function fetchTweet(){
				console.log("fetching...")
				$.ajax({
						url:"/api/tweet",
						data: {
							'q':query
						},
						method: "GET",
						success: function(data){
							// console.log("data " + data);
							tweetList = data
							parseTweet()
						},
						error : function(data){
							console.log("Error");
							console.log(data);
						}
				})
			}

			fetchTweet()

			$("#tweet-form").submit(function(event){
				event.preventDefault();
				var this_ = $(this);
				var formData = this_.serialize();
				$.ajax({
						url:"/api/tweet/create/",
						data: formData,
						method: "POST",
						success: function(data){
							console.log(data);
							fetchTweet()
						},
						error : function(data){
							console.log("Error");
							console.log(data);
							console.log(data.status);
							console.log(data.statusText);
						}
				})
				// console.log("formdata : " + formData);
				// fetchTweet()
			})

		});

	</script>
{% endblock script %}

{% block content %}
	<div class="row">
		<div class="col-sm-3 col-xs-12" style="background-color: red;">
			<h1>{{ request.user }}</h1>
		</div>
		<div class="col-sm-9">
			{% if not request.GET.q %}
				<div class="">
					{% include "tweets/form.html" with form=create_form action_url=create_url form_id='tweet-form' btn_title="Tweet" %}
				</div>
			{% endif %}
			<hr>
			<div id="tweet-container">
		
			</div>
		</div>
	</div>
{% endblock content %}